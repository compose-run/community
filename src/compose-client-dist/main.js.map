{"mappings":"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","sources":["client/index.ts","src/shared-types.ts"],"sourcesContent":["import { useState, useEffect } from \"react\";\nimport { Request, Response, User } from \"./shared-types\";\n\n// Create WebSocket connection\nconst socket = new WebSocket(\"ws://localhost:3000\");\n\n// utils\nfunction safeParseJSON(str: string | null) {\n  if (!str) {\n    return null;\n  }\n\n  try {\n    return JSON.parse(str);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction send(data: Request) {\n  if (socketOpen) {\n    socket.send(JSON.stringify(data));\n  } else {\n    queuedMessages.push(data);\n  }\n}\n\n// https://blog.trannhat.xyz/generate-a-hash-from-string-in-javascript/\nconst hashCode = function (s: string) {\n  return s.split(\"\").reduce(function (a, b) {\n    a = (a << 5) - a + b.charCodeAt(0);\n    return a & a;\n  }, 0);\n};\n\n// globals\nconst subscriptions: {\n  [key: string]: Set<(data: React.SetStateAction<unknown>) => void>;\n} = {};\n\nlet loggedInUser: User | null = null;\nif (localStorage.getItem(\"ComposeCachedUser\")) {\n  loggedInUser = safeParseJSON(localStorage.getItem(\"ComposeCachedUser\"));\n}\nconst loggedInUserSubscriptions = new Set<(user: User) => void>();\n\nconst ensureSet = (name: string) =>\n  (subscriptions[name] = subscriptions[name] || new Set());\n\nconst magicLinkLoginCallbacks: {\n  [key: string]: [(user: User) => void, (error: string) => void];\n} = {};\n\n//////////////////////////////////////////\n// SETUP\n//////////////////////////////////////////\n\n// On page load, check if the URL contains the `magicLinkToken` param\nconst magicLinkToken = new URLSearchParams(window.location.search).get(\n  \"ComposeMagicLinkToken\"\n);\nif (magicLinkToken) {\n  send({\n    type: \"LoginRequest\",\n    token: magicLinkToken,\n  });\n}\n\nlet socketOpen = false;\nconst queuedMessages: Request[] = [];\nsocket.addEventListener(\"open\", function (event) {\n  socketOpen = true;\n  queuedMessages.forEach(send);\n\n  if (localStorage.getItem(\"compose-token\")) {\n    send({\n      type: \"LoginRequest\",\n      token: localStorage.getItem(\"compose-token\") as string,\n    });\n  }\n});\n\nsocket.addEventListener(\"close\", function (event) {\n  socketOpen = false;\n  // TODO - reopen socket\n});\n\n//////////////////////////////////////////\n// HANDLE SERVER RESPONSES\n//////////////////////////////////////////\n\nsocket.addEventListener(\"message\", function (event) {\n  const data: Response | null = safeParseJSON(event.data);\n  if (!data) {\n    console.error(\"Invalid JSON received from server\");\n    console.error(event);\n    return;\n  }\n\n  if (\n    data.type === \"SubscribeResponse\" ||\n    data.type === \"UpdatedValueResponse\"\n  ) {\n    ensureSet(data.name).forEach((callback) => callback(data.value));\n  } else if (data.type === \"LoginResponse\") {\n    if (data.token) {\n      localStorage.setItem(\"compose-token\", data.token);\n      loggedInUser = data.user || null;\n      magicLinkLoginCallbacks[data.requestId as string]?.[0](data.user as User);\n    } else if (data.error) {\n      magicLinkLoginCallbacks[data.requestId as string]?.[1](data.error);\n    } else {\n      // token already saved in localStorage, so just call the callback\n      loggedInUser = data.user || null;\n      magicLinkLoginCallbacks[data.requestId as string]?.[0](data.user as User);\n    }\n  } else if (data.type === \"ParseErrorResponse\") {\n    console.error(\"Sent invalid JSON to server\");\n    console.error(data.cause);\n  }\n});\n\n//////////////////////////////////////////\n// Common: Cloud State & Reducer\n//////////////////////////////////////////\n\nfunction useSubscription(name: string, setState: (data: unknown) => void) {\n  useEffect(() => {\n    if (!ensureSet(name).size) {\n      send({\n        type: \"SubscribeRequest\",\n        name,\n      });\n    }\n    subscriptions[name].add(setState);\n    return () => {\n      subscriptions[name].delete(setState);\n      if (!ensureSet(name).size) {\n        socket.send(\n          JSON.stringify({\n            action: \"unsubscribe\",\n            name,\n          })\n        );\n      }\n    };\n  }, [setState]);\n}\n\n//////////////////////////////////////////\n// Cloud State\n//////////////////////////////////////////\n\nexport function setCloudState<A>(name: string, value: unknown) {\n  socket.send(\n    JSON.stringify({\n      action: \"update\",\n      name,\n      value,\n    })\n  );\n}\n\nexport function useCloudState(name: string, initialState: unknown) {\n  const [state, setState] = useState(initialState);\n  useSubscription(name, setState);\n  return [state, (s: unknown) => setCloudState(name, s)];\n}\n\n//////////////////////////////////////////\n// CLOUD REDUCER\n//////////////////////////////////////////\n\nexport function dispatchCloudReducerEvent<A>(name: string, event: A) {\n  send({\n    type: \"ReducerEventRequest\",\n    name,\n    value: event,\n  });\n}\n\nexport function useCloudReducer<State, Action, Response>({\n  name,\n  initialState,\n  reducer,\n  isPrivate = true,\n}: {\n  name: string;\n  initialState: State;\n  reducer: (\n    state: State,\n    action: Action,\n    reducer: (response: Response) => void\n  ) => State;\n  isPrivate: boolean;\n}) {\n  const [state, setState] = useState(initialState as unknown);\n  useSubscription(name, setState);\n\n  useEffect(() => {\n    console.log();\n    send({\n      type: \"RegisterReducerRequest\",\n      name,\n      reducerCode: reducer.toString(),\n      isPrivate,\n      initialState,\n    });\n  }, [name, reducer.toString(), isPrivate, JSON.stringify(initialState)]);\n\n  return [state, (s: State) => dispatchCloudReducerEvent(name, s)];\n}\n\n//////////////////////////////////////////\n// USER & AUTH\n//////////////////////////////////////////\n\nfunction magicLinkLogin({\n  email,\n  appName,\n  redirectUrl,\n}: {\n  email: string;\n  appName: string;\n  redirectUrl?: string;\n}): Promise<User> {\n  const requestId = Math.random().toString();\n  const promise = new Promise<User>((resolve, reject) => {\n    magicLinkLoginCallbacks[requestId] = [resolve, reject];\n  });\n\n  redirectUrl = redirectUrl || window.location.href;\n\n  socket.send(\n    JSON.stringify({\n      action: \"MagicLinkLogin\",\n      email,\n      appName,\n      redirectUrl,\n      requestId,\n    })\n  );\n\n  return promise;\n}\n\nexport function useLoggedInUser() {\n  const [user, setUser] = useState<User | null>(null);\n  useEffect(() => {\n    loggedInUserSubscriptions.add(setUser);\n    return () => {\n      loggedInUserSubscriptions.delete(setUser);\n    };\n  }, []);\n  return user;\n}\n\nexport function logout() {\n  localStorage.removeItem(\"compose-token\");\n  socket.send(JSON.stringify({ type: \"LogoutRequest\" }));\n}\n","// THIS FILE IS DUPLICATED IN THE CLIENT SIDE LIBRARY\n\nexport interface User {\n  email: string;\n  id: number;\n}\n\ninterface SendMagicLinkRequest {\n  type: \"SendMagicLinkRequest\";\n  email: string;\n  appName: string;\n  redirectURL: string;\n  requestId: string;\n}\n\ninterface LoginRequest {\n  type: \"LoginRequest\";\n  token: string;\n}\n\ninterface LogoutRequest {\n  type: \"LogoutRequest\";\n}\n\ninterface SubscribeRequest {\n  type: \"SubscribeRequest\";\n  name: string;\n}\n\ninterface UnsubscribeRequest {\n  type: \"UnsubscribeRequest\";\n  name: string;\n}\n\ninterface StateUpdateRequest {\n  type: \"StateUpdateRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface ReducerEventRequest {\n  type: \"ReducerEventRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface RegisterReducerRequest {\n  type: \"RegisterReducerRequest\";\n  name: string;\n  initialState: unknown;\n  reducerCode: string;\n  isPrivate: boolean;\n}\n\nexport type Request =\n  | SendMagicLinkRequest\n  | LoginRequest\n  | LogoutRequest\n  | SubscribeRequest\n  | UnsubscribeRequest\n  | StateUpdateRequest\n  | ReducerEventRequest\n  | RegisterReducerRequest;\n\ninterface SendMagicLinkResponse {\n  type: \"SendMagicLinkResponse\";\n  error?: string;\n  requestId: string;\n}\n\ninterface LoginResponse {\n  type: \"LoginResponse\";\n  token?: string;\n  error?: string;\n  requestId?: string;\n  user?: User;\n}\n\ninterface LogoutResponse {\n  type: \"LogoutResponse\";\n  error?: string;\n}\n\ninterface UpdatedValueProperties {\n  name: string;\n  value: unknown;\n  timestamp?: number;\n}\n\ninterface SubscribeResponse extends UpdatedValueProperties {\n  type: \"SubscribeResponse\";\n}\n\ninterface UpdatedValueResponse extends UpdatedValueProperties {\n  type: \"UpdatedValueResponse\";\n}\n\ninterface UnsubscribeResponse {\n  type: \"UnsubscribeResponse\";\n  name: string;\n  error?: string;\n}\n\ninterface StateUpdateResponse {\n  type: \"StateUpdate\";\n  name: string;\n  value: unknown;\n}\n\ninterface ReducerEventResponse {\n  type: \"ReducerEvent\";\n  name: string;\n  value: unknown;\n}\n\ninterface ParseErrorResponse {\n  type: \"ParseErrorResponse\";\n  cause: string;\n}\n\ninterface RegisterReducerResponse {\n  type: \"RegisterReducerResponse\";\n  name: string;\n  error?: \"Unauthorized\" | string;\n  warn?: \"New initial state ignored\" | string;\n}\n\nexport type Response =\n  | SendMagicLinkResponse\n  | LoginResponse\n  | LogoutResponse\n  | SubscribeResponse\n  | UnsubscribeResponse\n  | StateUpdateResponse\n  | ReducerEventResponse\n  | UpdatedValueResponse\n  | ParseErrorResponse\n  | RegisterReducerResponse;\n"],"names":[],"version":3,"file":"main.js.map"}