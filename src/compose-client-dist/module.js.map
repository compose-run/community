{"mappings":";;;;;AAGA,EAA0C,AAA1C,wCAA0C;AAC1C,EAAU,AAAV,QAAU;AACV,EAA0C,AAA1C,wCAA0C;AAE1C,KAAK,CAAC,4CAAsB,GAAG,CAAoB;AACnD,KAAK,CAAC,uCAAiB,GAAG,CAAe;AAEzC,KAAK,CAAC,mCAAa,GAEf,CAAC;AAAA,CAAC;AAEN,GAAG,CAAC,kCAAY,GAAgB,IAAI;AACpC,EAAE,EAAE,YAAY,CAAC,OAAO,CAAC,4CAAsB,GAC7C,kCAAY,GAAG,mCAAa,CAAC,YAAY,CAAC,OAAO,CAAC,4CAAsB;AAE1E,KAAK,CAAC,+CAAyB,GAAG,GAAG,CAAC,GAAG;AAEzC,KAAK,CAAC,+BAAS,IAAI,IAAY,GAC5B,mCAAa,CAAC,IAAI,IAAI,mCAAa,CAAC,IAAI,KAAK,GAAG,CAAC,GAAG;;AAEvD,KAAK,CAAC,+BAAS,GAEX,CAAC;AAAA,CAAC;AACN,KAAK,CAAC,kCAAY,IAAI,IAAY,GAAK,CAAC;IACtC,MAAM,CAAC,+BAAS,CAAC,IAAI,KAAK,CAAC;YAAM,IAAI,CAAC,CAAC;;YAAQ,IAAI,CAAC,CAAC;IAAA,CAAC;AACxD,CAAC;AAED,GAAG,CAAC,gCAAU,GAAG,KAAK;AACtB,GAAG,CAAC,oCAAc,GAAe,CAAC,CAAC;AAEnC,GAAG,CAAC,4BAAM;AAEV,EAA0C,AAA1C,wCAA0C;AAC1C,EAAQ,AAAR,MAAQ;AACR,EAA0C,AAA1C,wCAA0C;SAEjC,mCAAa,CAAC,GAAkB,EAAE,CAAC;IAC1C,EAAE,GAAG,GAAG,EACN,MAAM,CAAC,IAAI;IAGb,GAAG,CAAC,CAAC;QACH,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG;IACvB,CAAC,CAAC,KAAK,EAAE,CAAC,EAAE,CAAC;QACX,MAAM,CAAC,IAAI;IACb,CAAC;AACH,CAAC;SAEQ,0BAAI,CAAC,IAAa,EAAE,CAAC;IAC5B,KAAK,CAAC,SAAS,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE,QAAQ,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC;IAC9D,MAAM,CAAC,GAAG,CAAC,OAAO,EAAQ,OAAO,EAAE,MAAM,GAAK,CAAC;QAC7C,+BAAS,CAAC,SAAS,IAAI,CAAC;YAAA,OAAO;YAAE,MAAM;QAAA,CAAC;QACxC,EAAE,EAAE,gCAAU,EACZ,kCAAY,CAAC,CAAC;eAAI,IAAI;uBAAE,SAAS;QAAC,CAAC;aAEnC,EAAmD,AAAnD,iDAAmD;QACnD,EAAoD,AAApD,kDAAoD;QACpD,EAAqD,AAArD,mDAAqD;QACrD,oCAAc,CAAC,IAAI,CAAC,CAAC;eAAI,IAAI;uBAAE,SAAS;QAAC,CAAC;IAE9C,CAAC;AACH,CAAC;SAEQ,kCAAY,CAAC,IAAc,EAAE,CAAC;IACrC,GAAG,CAAC,CAAC;QACH,4BAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI;QAC/B,oCAAc,GAAG,oCAAc,CAAC,MAAM,EACnC,CAAC,GAAK,CAAC,CAAC,SAAS,KAAK,IAAI,CAAC,SAAS;;IAEzC,CAAC,CAAC,KAAK,EAAE,CAAC,EAAE,CAAC;QACX,OAAO,CAAC,KAAK,CAAC,CAAC;IACjB,CAAC;AACH,CAAC;SAEQ,iCAAW,CAAC,IAAY,EAAE,KAAc,EAAE,CAAC;IAClD,+BAAS,CAAC,IAAI,EAAE,OAAO,EAAE,QAAQ,GAAK,QAAQ,CAAC,KAAK;;AACpD,EAAqC,AAArC,mCAAqC;AACvC,CAAC;AAED,EAAuE,AAAvE,qEAAuE;AACvE,KAAK,CAAC,8BAAQ,GAAG,QAAQ,CAAE,CAAS,EAAE,CAAC;IACrC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,CAAE,GAAE,MAAM,CAAC,QAAQ,CAAE,CAAC,EAAE,CAAC,EAAE,CAAC;QACzC,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,UAAU,CAAC,CAAC;QACjC,MAAM,CAAC,CAAC,GAAG,CAAC;IACd,CAAC,EAAE,CAAC;AACN,CAAC;AAED,EAA0C,AAA1C,wCAA0C;AAC1C,EAAQ,AAAR,MAAQ;AACR,EAA0C,AAA1C,wCAA0C;AAE1C,EAAqE,AAArE,mEAAqE;AACrE,KAAK,CAAC,oCAAc,GAAG,GAAG,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,GAAG,CACpE,CAAc;AAEhB,EAAE,EAAE,oCAAc,EAChB,0BAAI,CAAC,CAAC;IACJ,IAAI,EAAE,CAAc;IACpB,KAAK,EAAE,oCAAc;AACvB,CAAC;AAGH,EAA0C,AAA1C,wCAA0C;AAC1C,EAA0B,AAA1B,wBAA0B;AAC1B,EAA0C,AAA1C,wCAA0C;AAE1C,KAAK,CAAC,0CAAoB,GAAG,QAAQ,CAAE,KAAmB,EAAE,CAAC;IAC3D,KAAK,CAAC,IAAI,GAAoB,mCAAa,CAAC,KAAK,CAAC,IAAI;IACtD,EAAE,GAAG,IAAI,EAAE,CAAC;QACV,OAAO,CAAC,KAAK,CAAC,CAAmC;QACjD,OAAO,CAAC,KAAK,CAAC,KAAK;QACnB,MAAM;IACR,CAAC;IAED,EAAE,EACA,IAAI,CAAC,IAAI,KAAK,CAAmB,sBACjC,IAAI,CAAC,IAAI,KAAK,CAAsB;QAEpC,EAAE,EAAE,IAAI,CAAC,IAAI,KAAK,CAAsB,yBAAI,IAAI,CAAC,KAAK,EACpD,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,KACzB,IAAI,CAAC,IAAI,CAAC,qEAAqE;aAE/E,CAAC;YACN,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK;YAC1C,iCAAW,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK;QACnC,CAAC;WACI,EAAE,EAAE,IAAI,CAAC,IAAI,KAAK,CAAe,gBAAE,CAAC;QACzC,EAAE,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC;YACf,YAAY,CAAC,OAAO,CAAC,uCAAiB,EAAE,IAAI,CAAC,KAAK;YAClD,YAAY,CAAC,OAAO,CAAC,4CAAsB,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI;YACrE,kCAAY,GAAG,IAAI,CAAC,IAAI,IAAI,IAAI;YAChC,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,IAAI;YACzC,+CAAyB,CAAC,OAAO,EAAE,QAAQ,GACzC,QAAQ,CAAC,IAAI,CAAC,IAAI;;QAEtB,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,KAAK,EACnB,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK;aACrC,CAAC;YACN,EAAiE,AAAjE,+DAAiE;YACjE,kCAAY,GAAG,IAAI,CAAC,IAAI,IAAI,IAAI;YAChC,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,IAAI;QAC3C,CAAC;IACH,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,IAAI,KAAK,CAAoB,qBAAE,CAAC;QAC9C,OAAO,CAAC,KAAK,CAAC,CAA6B;QAC3C,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK;IAC1B,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,IAAI,KAAK,CAAyB,0BAAE,CAAC;QACnD,kCAAY,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,EAAE,IAAI,CAAC,YAAY;QACjD,iCAAW,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,WAAW;IACzC,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,IAAI,KAAK,CAAsB,uBAAE,CAAC;QAChD,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,GAAG,GAAK,OAAO,CAAC,GAAG,IAAI,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,GAAG;;QAC/D,EAAE,EAAE,IAAI,CAAC,KAAK,EACZ,OAAO,CAAC,KAAK,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC,KAAK;IAErD,CAAC,MACC,OAAO,CAAC,IAAI,EAAE,2CAA2C,EAAE,IAAI,CAAC,IAAI;AAExE,CAAC;AAED,EAA0C,AAA1C,wCAA0C;AAC1C,EAAkB,AAAlB,gBAAkB;AAClB,EAA0C,AAA1C,wCAA0C;AAE1C,KAAK,CAAC,sCAAgB,aAAe,CAAC;IACpC,gCAAU,GAAG,IAAI;IACjB,EAAE,EAAE,YAAY,CAAC,OAAO,CAAC,uCAAiB,GACxC,0BAAI,CAAC,CAAC;QACJ,IAAI,EAAE,CAAc;QACpB,KAAK,EAAE,YAAY,CAAC,OAAO,CAAC,uCAAiB;IAC/C,CAAC;IAEH,EAA8D,AAA9D,4DAA8D;IAC9D,EAAqE,AAArE,mEAAqE;IACrE,GAAG,EAAE,KAAK,CAAC,OAAO,IAAI,oCAAc,CAClC,KAAK,CAAC,kCAAY,CAAC,OAAO;AAE9B,CAAC;AAED,KAAK,CAAC,uCAAiB,GAAG,QAAQ,GAAI,CAAC;IACrC,gCAAU,GAAG,KAAK;IAClB,UAAU,CAAC,oCAAc,EAAE,GAAG;AAChC,CAAC;SAEQ,oCAAc,GAAG,CAAC;IACzB,EAAE,EAAE,4BAAM,EAAE,4BAAM,CAAC,KAAK;IAExB,GAAG,CAAC,CAAC;QACH,4BAAM,GAAG,GAAG,CAAC,SAAS,CAAC,CAAqB,sBAAG,CAAwC,AAAxC,EAAwC,AAAxC,sCAAwC;QACvF,4BAAM,CAAC,gBAAgB,CAAC,CAAS,UAAE,0CAAoB;QACvD,4BAAM,CAAC,gBAAgB,CAAC,CAAM,OAAE,sCAAgB;QAChD,4BAAM,CAAC,gBAAgB,CAAC,CAAO,QAAE,uCAAiB;IACpD,CAAC,CAAC,KAAK,EAAE,CAAC,EAAE,CAAC;QACX,OAAO,CAAC,KAAK,CAAC,CAAC;IACjB,CAAC;AACH,CAAC;AACD,oCAAc;AAEd,EAA0C,AAA1C,wCAA0C;AAC1C,EAAgC,AAAhC,8BAAgC;AAChC,EAA0C,AAA1C,wCAA0C;SAEjC,qCAAe,CAAC,IAAY,EAAE,QAAiC,EAAE,CAAC;IACzE,gBAAS,KAAO,CAAC;QACf,EAAE,GAAG,+BAAS,CAAC,IAAI,EAAE,IAAI,EACvB,0BAAI,CAAC,CAAC;YACJ,IAAI,EAAE,CAAkB;kBACxB,IAAI;QACN,CAAC;QAEH,mCAAa,CAAC,IAAI,EAAE,GAAG,CAAC,QAAQ;QAChC,MAAM,KAAO,CAAC;YACZ,mCAAa,CAAC,IAAI,EAAE,MAAM,CAAC,QAAQ;YACnC,EAAE,GAAG,+BAAS,CAAC,IAAI,EAAE,IAAI,EACvB,4BAAM,CAAC,IAAI,CACT,IAAI,CAAC,SAAS,CAAC,CAAC;gBACd,MAAM,EAAE,CAAa;sBACrB,IAAI;YACN,CAAC;QAGP,CAAC;IACH,CAAC,EAAE,CAAC;QAAA,QAAQ;IAAA,CAAC;AACf,CAAC;SAMe,yCAAa,CAAI,IAAY,EAAE,KAAc,EAAE,CAAC;IAC9D,0BAAI,CAAC,CAAC;QACJ,IAAI,EAAE,CAAoB;cAC1B,IAAI;eACJ,KAAK;IACP,CAAC;AACH,CAAC;SAEe,yCAAa,CAAC,IAAY,EAAE,YAAqB,EAAE,CAAC;IAClE,KAAK,EAAE,KAAK,EAAE,QAAQ,IAAI,eAAQ,CAAC,YAAY;IAC/C,qCAAe,CAAC,IAAI,EAAE,QAAQ;IAC9B,MAAM,CAAC,CAAC;QAAA,KAAK;SAAG,CAAU,GAAK,yCAAa,CAAC,IAAI,EAAE,CAAC;IAAC,CAAC;AACxD,CAAC;SAMe,yCAAyB,CAAI,IAAY,EAAE,KAAQ,EAAE,CAAC;IACpE,0BAAI,CAAC,CAAC;QACJ,IAAI,EAAE,CAAqB;cAC3B,IAAI;QACJ,KAAK,EAAE,KAAK;IACd,CAAC;AACH,CAAC;SAEe,yCAAe,CAA0B,CAAC,OACxD,IAAI,iBACJ,YAAY,YACZ,OAAO,EAST,CAAC,EAAE,CAAC;IACF,KAAK,EAAE,KAAK,EAAE,QAAQ,IAAI,eAAQ,CAAC,YAAY;IAC/C,qCAAe,CAAC,IAAI,EAAE,QAAQ;IAE9B,gBAAS,KAAO,CAAC;QACf,0BAAI,CAAC,CAAC;YACJ,IAAI,EAAE,CAAwB;kBAC9B,IAAI;YACJ,WAAW,EAAE,OAAO,CAAC,QAAQ;0BAC7B,YAAY;QACd,CAAC;IACH,CAAC,EAAE,CAAC;QAAA,IAAI;QAAE,OAAO,CAAC,QAAQ;QAAI,IAAI,CAAC,SAAS,CAAC,YAAY;IAAC,CAAC;IAE3D,MAAM,CAAC,CAAC;QAAA,KAAK;SAAG,CAAQ,GAAK,yCAAyB,CAAC,IAAI,EAAE,CAAC;IAAC,CAAC;AAClE,CAAC;SAMe,yCAAc,CAAC,CAAC,QAC9B,KAAK,YACL,OAAO,gBACP,WAAW,EAKb,CAAC,EAAiB,CAAC;IACjB,WAAW,GAAG,WAAW,IAAI,MAAM,CAAC,QAAQ,CAAC,IAAI;IACjD,MAAM,CAAC,0BAAI,CAAC,CAAC;QACX,IAAI,EAAE,CAAsB;eAC5B,KAAK;iBACL,OAAO;qBACP,WAAW;IACb,CAAC;AACH,CAAC;SAEe,yCAAO,GAAG,CAAC;IACzB,KAAK,EAAE,IAAI,EAAE,OAAO,IAAI,eAAQ,CAAc,kCAAY;IAC1D,gBAAS,KAAO,CAAC;QACf,+CAAyB,CAAC,GAAG,CAAC,OAAO;QACrC,MAAM,KAAO,CAAC;YACZ,+CAAyB,CAAC,MAAM,CAAC,OAAO;QAC1C,CAAC;IACH,CAAC,EAAE,CAAC,CAAC;IACL,MAAM,CAAC,IAAI;AACb,CAAC;SAEe,yCAAM,GAAG,CAAC;IACxB,YAAY,CAAC,UAAU,CAAC,uCAAiB;IACzC,YAAY,CAAC,UAAU,CAAC,4CAAsB;IAC9C,4BAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAAC,IAAI,EAAE,CAAe;IAAC,CAAC;AACtD,CAAC","sources":["client/index.ts","src/shared-types.ts"],"sourcesContent":["import { useState, useEffect } from \"react\";\nimport { Request, Request_, Response, User } from \"./shared-types\";\n\n//////////////////////////////////////////\n// GLOBALS\n//////////////////////////////////////////\n\nconst COMPOSE_USER_CACHE_KEY = \"compose-cache:user\";\nconst COMPOSE_TOKEN_KEY = \"compose-token\";\n\nconst subscriptions: {\n  [key: string]: Set<(data: React.SetStateAction<unknown>) => void>;\n} = {};\n\nlet loggedInUser: User | null = null;\nif (localStorage.getItem(COMPOSE_USER_CACHE_KEY)) {\n  loggedInUser = safeParseJSON(localStorage.getItem(COMPOSE_USER_CACHE_KEY));\n}\nconst loggedInUserSubscriptions = new Set<(user: User) => void>();\n\nconst ensureSet = (name: string) =>\n  (subscriptions[name] = subscriptions[name] || new Set());\n\nconst callbacks: {\n  [key: string]: [(...args: any[]) => void, (error: string) => void];\n} = {};\nconst getCallbacks = (name: string) => {\n  return callbacks[name] || [() => void 0, () => void 0];\n};\n\nlet socketOpen = false;\nlet queuedMessages: Request_[] = [];\n\nlet socket: WebSocket;\n\n//////////////////////////////////////////\n// UTILS\n//////////////////////////////////////////\n\nfunction safeParseJSON(str: string | null) {\n  if (!str) {\n    return null;\n  }\n\n  try {\n    return JSON.parse(str);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction send(data: Request) {\n  const requestId = (Math.random() + 1).toString(36).substring(7);\n  return new Promise<User>((resolve, reject) => {\n    callbacks[requestId] = [resolve, reject];\n    if (socketOpen) {\n      actuallySend({ ...data, requestId });\n    } else {\n      // TODO - after a while, close and try to reconnect\n      // TODO - eventually, throw an error (promise throw)\n      //        on all the places that pushed to this queue\n      queuedMessages.push({ ...data, requestId });\n    }\n  });\n}\n\nfunction actuallySend(data: Request_) {\n  try {\n    socket.send(JSON.stringify(data));\n    queuedMessages = queuedMessages.filter(\n      (d) => d.requestId !== data.requestId\n    );\n  } catch (e) {\n    console.error(e);\n  }\n}\n\nfunction updateValue(name: string, value: unknown) {\n  ensureSet(name).forEach((callback) => callback(value));\n  // TODO - cache value in localstorage\n}\n\n// https://blog.trannhat.xyz/generate-a-hash-from-string-in-javascript/\nconst hashCode = function (s: string) {\n  return s.split(\"\").reduce(function (a, b) {\n    a = (a << 5) - a + b.charCodeAt(0);\n    return a & a;\n  }, 0);\n};\n\n//////////////////////////////////////////\n// SETUP\n//////////////////////////////////////////\n\n// On page load, check if the URL contains the `magicLinkToken` param\nconst magicLinkToken = new URLSearchParams(window.location.search).get(\n  \"composeToken\"\n);\nif (magicLinkToken) {\n  send({\n    type: \"LoginRequest\",\n    token: magicLinkToken,\n  });\n}\n\n//////////////////////////////////////////\n// HANDLE SERVER RESPONSES\n//////////////////////////////////////////\n\nconst handleServerResponse = function (event: MessageEvent) {\n  const data: Response | null = safeParseJSON(event.data);\n  if (!data) {\n    console.error(\"Invalid JSON received from server\");\n    console.error(event);\n    return;\n  }\n\n  if (\n    data.type === \"SubscribeResponse\" ||\n    data.type === \"UpdatedValueResponse\"\n  ) {\n    if (data.type === \"UpdatedValueResponse\" && data.error) {\n      getCallbacks(data.requestId)[1](\n        `${data.name}: Cannot set this state because there is a reducer with the same name`\n      );\n    } else {\n      getCallbacks(data.requestId)[0](data.value);\n      updateValue(data.name, data.value);\n    }\n  } else if (data.type === \"LoginResponse\") {\n    if (data.token) {\n      localStorage.setItem(COMPOSE_TOKEN_KEY, data.token);\n      localStorage.setItem(COMPOSE_USER_CACHE_KEY, JSON.stringify(data.user));\n      loggedInUser = data.user || null;\n      getCallbacks(data.requestId)[0](data.user);\n      loggedInUserSubscriptions.forEach((callback) =>\n        callback(data.user as User)\n      );\n    } else if (data.error) {\n      getCallbacks(data.requestId)[1](data.error);\n    } else {\n      // token already saved in localStorage, so just call the callback\n      loggedInUser = data.user || null;\n      getCallbacks(data.requestId)[0](data.user);\n    }\n  } else if (data.type === \"ParseErrorResponse\") {\n    console.error(\"Sent invalid JSON to server\");\n    console.error(data.cause);\n  } else if (data.type === \"ResolveDispatchResponse\") {\n    getCallbacks(data.requestId)[0](data.resolveValue);\n    updateValue(data.name, data.returnValue);\n  } else if (data.type === \"RuntimeDebugResponse\") {\n    data.consoles.forEach((log) => console.log(`${data.name}: ${log}`));\n    if (data.error) {\n      console.error(`${data.name}\\n\\n${data.error.stack}`);\n    }\n  } else {\n    console.warn(`Unknown response type from Compose server: ${data.type}`);\n  }\n};\n\n//////////////////////////////////////////\n// Setup Websocket\n//////////////////////////////////////////\n\nconst handleSocketOpen = async () => {\n  socketOpen = true;\n  if (localStorage.getItem(COMPOSE_TOKEN_KEY)) {\n    send({\n      type: \"LoginRequest\",\n      token: localStorage.getItem(COMPOSE_TOKEN_KEY) as string,\n    });\n  }\n  // maybe sending while awaiting to ensure ordering is overkill\n  // we can definitely include local ordering inside the message itself\n  for (const message of queuedMessages) {\n    await actuallySend(message);\n  }\n};\n\nconst handleSocketClose = function () {\n  socketOpen = false;\n  setTimeout(setupWebsocket, 200);\n};\n\nfunction setupWebsocket() {\n  if (socket) socket.close();\n\n  try {\n    socket = new WebSocket(\"ws://localhost:3000\"); // TODO - point this to prod on releases\n    socket.addEventListener(\"message\", handleServerResponse);\n    socket.addEventListener(\"open\", handleSocketOpen);\n    socket.addEventListener(\"close\", handleSocketClose);\n  } catch (e) {\n    console.error(e);\n  }\n}\nsetupWebsocket();\n\n//////////////////////////////////////////\n// Common: Cloud State & Reducer\n//////////////////////////////////////////\n\nfunction useSubscription(name: string, setState: (data: unknown) => void) {\n  useEffect(() => {\n    if (!ensureSet(name).size) {\n      send({\n        type: \"SubscribeRequest\",\n        name,\n      });\n    }\n    subscriptions[name].add(setState);\n    return () => {\n      subscriptions[name].delete(setState);\n      if (!ensureSet(name).size) {\n        socket.send(\n          JSON.stringify({\n            action: \"unsubscribe\", // TODO - fix this\n            name,\n          })\n        );\n      }\n    };\n  }, [setState]);\n}\n\n//////////////////////////////////////////\n// Cloud State\n//////////////////////////////////////////\n\nexport function setCloudState<A>(name: string, value: unknown) {\n  send({\n    type: \"StateUpdateRequest\",\n    name,\n    value,\n  });\n}\n\nexport function useCloudState(name: string, initialState: unknown) {\n  const [state, setState] = useState(initialState);\n  useSubscription(name, setState);\n  return [state, (s: unknown) => setCloudState(name, s)];\n}\n\n//////////////////////////////////////////\n// CLOUD REDUCER\n//////////////////////////////////////////\n\nexport function dispatchCloudReducerEvent<A>(name: string, event: A) {\n  send({\n    type: \"ReducerEventRequest\",\n    name,\n    value: event,\n  });\n}\n\nexport function useCloudReducer<State, Action, Response>({\n  name,\n  initialState,\n  reducer,\n}: {\n  name: string;\n  initialState: State;\n  reducer: (\n    state: State,\n    action: Action,\n    reducer: (response: Response) => void\n  ) => State;\n}) {\n  const [state, setState] = useState(initialState as unknown);\n  useSubscription(name, setState);\n\n  useEffect(() => {\n    send({\n      type: \"RegisterReducerRequest\",\n      name,\n      reducerCode: reducer.toString(),\n      initialState,\n    });\n  }, [name, reducer.toString(), JSON.stringify(initialState)]);\n\n  return [state, (s: State) => dispatchCloudReducerEvent(name, s)];\n}\n\n//////////////////////////////////////////\n// USER & AUTH\n//////////////////////////////////////////\n\nexport function magicLinkLogin({\n  email,\n  appName,\n  redirectURL,\n}: {\n  email: string;\n  appName: string;\n  redirectURL?: string;\n}): Promise<User> {\n  redirectURL = redirectURL || window.location.href;\n  return send({\n    type: \"SendMagicLinkRequest\",\n    email,\n    appName,\n    redirectURL,\n  });\n}\n\nexport function useUser() {\n  const [user, setUser] = useState<User | null>(loggedInUser);\n  useEffect(() => {\n    loggedInUserSubscriptions.add(setUser);\n    return () => {\n      loggedInUserSubscriptions.delete(setUser);\n    };\n  }, []);\n  return user;\n}\n\nexport function logout() {\n  localStorage.removeItem(COMPOSE_TOKEN_KEY);\n  localStorage.removeItem(COMPOSE_USER_CACHE_KEY);\n  socket.send(JSON.stringify({ type: \"LogoutRequest\" }));\n}\n","// THIS FILE IS DUPLICATED IN THE CLIENT SIDE LIBRARY\n\nexport interface User {\n  email: string;\n  id: number;\n}\ninterface SendMagicLinkRequest {\n  type: \"SendMagicLinkRequest\";\n  email: string;\n  appName: string;\n  redirectURL: string;\n}\n\ninterface LoginRequest {\n  type: \"LoginRequest\";\n  token: string;\n}\n\ninterface LogoutRequest {\n  type: \"LogoutRequest\";\n}\n\ninterface SubscribeRequest {\n  type: \"SubscribeRequest\";\n  name: string;\n}\n\ninterface UnsubscribeRequest {\n  type: \"UnsubscribeRequest\";\n  name: string;\n}\n\ninterface StateUpdateRequest {\n  type: \"StateUpdateRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface ReducerEventRequest {\n  type: \"ReducerEventRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface RegisterReducerRequest {\n  type: \"RegisterReducerRequest\";\n  name: string;\n  initialState: unknown;\n  reducerCode: string;\n}\n\nexport type Request =\n  | SendMagicLinkRequest\n  | LoginRequest\n  | LogoutRequest\n  | SubscribeRequest\n  | UnsubscribeRequest\n  | StateUpdateRequest\n  | ReducerEventRequest\n  | RegisterReducerRequest;\n\nexport type Request_ = Request & { requestId: string };\ninterface SendMagicLinkResponse {\n  type: \"SendMagicLinkResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface LoginResponse {\n  type: \"LoginResponse\";\n  requestId: string;\n  token?: string;\n  error?: string;\n  user?: User;\n}\n\ninterface LogoutResponse {\n  type: \"LogoutResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface UpdatedValueProperties {\n  name: string;\n  value: unknown;\n  timestamp?: number;\n}\n\ninterface SubscribeResponse extends UpdatedValueProperties {\n  type: \"SubscribeResponse\";\n  requestId: string;\n}\n\ninterface UpdatedValueResponse extends UpdatedValueProperties {\n  type: \"UpdatedValueResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface UnsubscribeResponse {\n  type: \"UnsubscribeResponse\";\n  requestId: string;\n  name: string;\n  error?: string;\n}\n\ninterface ReducerEventResponse {\n  type: \"ReducerEvent\";\n  requestId: string;\n  name: string;\n  value: unknown;\n}\n\ninterface ParseErrorResponse {\n  type: \"ParseErrorResponse\";\n  cause: string;\n}\n\ninterface RegisterReducerResponse {\n  type: \"RegisterReducerResponse\";\n  requestId: string;\n  name: string;\n  error?: \"Unauthorized\" | string;\n  warn?: \"New initial state ignored\" | string;\n}\n\ninterface ResolveDispatchResponse {\n  type: \"ResolveDispatchResponse\";\n  name: string;\n  requestId: string;\n  resolveValue: unknown;\n  returnValue: unknown;\n}\n\ninterface SerializableError {\n  message: string | undefined;\n  stack: string | undefined;\n}\ninterface RuntimeDebugResponse {\n  type: \"RuntimeDebugResponse\";\n  name: string;\n  requestId: string;\n  resolveValue: unknown;\n  returnValue: unknown;\n  consoles: string[];\n  error: SerializableError | undefined;\n}\n\nexport type Response =\n  | SendMagicLinkResponse\n  | LoginResponse\n  | LogoutResponse\n  | SubscribeResponse\n  | UnsubscribeResponse\n  | ReducerEventResponse\n  | UpdatedValueResponse\n  | ParseErrorResponse\n  | RegisterReducerResponse\n  | ResolveDispatchResponse\n  | RuntimeDebugResponse;\n"],"names":[],"version":3,"file":"module.js.map"}