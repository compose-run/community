{"mappings":"AAEA;IACE,KAAK,EAAE,MAAM,CAAC;IACd,EAAE,EAAE,MAAM,CAAC;CACZ;ACuMD,8BAA8B,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,OAAO,QAM5D;AAED,8BAA8B,IAAI,EAAE,MAAM,EAAE,YAAY,EAAE,OAAO,aAIhE;AAMD,0CAA0C,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,QAMlE;AAED,gCAAgC,KAAK,EAAE,MAAM,EAAE,QAAQ,EAAE,EACvD,IAAI,EACJ,YAAY,EACZ,OAAO,GACR,EAAE;IACD,IAAI,EAAE,MAAM,CAAC;IACb,YAAY,EAAE,KAAK,CAAC;IACpB,OAAO,EAAE,CACP,KAAK,EAAE,KAAK,EACZ,MAAM,EAAE,MAAM,EACd,OAAO,EAAE,CAAC,QAAQ,EAAE,QAAQ,KAAK,IAAI,KAClC,KAAK,CAAC;CACZ,aAcA;AAMD,+BAA+B,EAC7B,KAAK,EACL,OAAO,EACP,WAAW,GACZ,EAAE;IACD,KAAK,EAAE,MAAM,CAAC;IACd,OAAO,EAAE,MAAM,CAAC;IAChB,WAAW,CAAC,EAAE,MAAM,CAAC;CACtB,GAAG,OAAO,CAAC,IAAI,CAAC,CAQhB;AAED,uCASC;AAED,+BAIC","sources":["client/shared-types.ts","client/index.ts"],"sourcesContent":["// THIS FILE IS DUPLICATED IN THE CLIENT SIDE LIBRARY\n\nexport interface User {\n  email: string;\n  id: number;\n}\ninterface SendMagicLinkRequest {\n  type: \"SendMagicLinkRequest\";\n  email: string;\n  appName: string;\n  redirectURL: string;\n}\n\ninterface LoginRequest {\n  type: \"LoginRequest\";\n  token: string;\n}\n\ninterface LogoutRequest {\n  type: \"LogoutRequest\";\n}\n\ninterface SubscribeRequest {\n  type: \"SubscribeRequest\";\n  name: string;\n}\n\ninterface UnsubscribeRequest {\n  type: \"UnsubscribeRequest\";\n  name: string;\n}\n\ninterface StateUpdateRequest {\n  type: \"StateUpdateRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface ReducerEventRequest {\n  type: \"ReducerEventRequest\";\n  name: string;\n  value: unknown;\n}\n\ninterface RegisterReducerRequest {\n  type: \"RegisterReducerRequest\";\n  name: string;\n  initialState: unknown;\n  reducerCode: string;\n}\n\nexport type Request =\n  | SendMagicLinkRequest\n  | LoginRequest\n  | LogoutRequest\n  | SubscribeRequest\n  | UnsubscribeRequest\n  | StateUpdateRequest\n  | ReducerEventRequest\n  | RegisterReducerRequest;\n\nexport type Request_ = Request & { requestId: string };\ninterface SendMagicLinkResponse {\n  type: \"SendMagicLinkResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface LoginResponse {\n  type: \"LoginResponse\";\n  requestId: string;\n  token?: string;\n  error?: string;\n  user?: User;\n}\n\ninterface LogoutResponse {\n  type: \"LogoutResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface UpdatedValueProperties {\n  name: string;\n  value: unknown;\n  timestamp?: number;\n}\n\ninterface SubscribeResponse extends UpdatedValueProperties {\n  type: \"SubscribeResponse\";\n  requestId: string;\n}\n\ninterface UpdatedValueResponse extends UpdatedValueProperties {\n  type: \"UpdatedValueResponse\";\n  requestId: string;\n  error?: string;\n}\n\ninterface UnsubscribeResponse {\n  type: \"UnsubscribeResponse\";\n  requestId: string;\n  name: string;\n  error?: string;\n}\n\ninterface ReducerEventResponse {\n  type: \"ReducerEvent\";\n  requestId: string;\n  name: string;\n  value: unknown;\n}\n\ninterface ParseErrorResponse {\n  type: \"ParseErrorResponse\";\n  cause: string;\n}\n\ninterface RegisterReducerResponse {\n  type: \"RegisterReducerResponse\";\n  requestId: string;\n  name: string;\n  error?: \"Unauthorized\" | string;\n  warn?: \"New initial state ignored\" | string;\n}\n\ninterface ResolveDispatchResponse {\n  type: \"ResolveDispatchResponse\";\n  name: string;\n  requestId: string;\n  resolveValue: unknown;\n  returnValue: unknown;\n}\n\ninterface SerializableError {\n  message: string | undefined;\n  stack: string | undefined;\n}\ninterface RuntimeDebugResponse {\n  type: \"RuntimeDebugResponse\";\n  name: string;\n  requestId: string;\n  resolveValue: unknown;\n  returnValue: unknown;\n  consoles: string[];\n  error: SerializableError | undefined;\n}\n\nexport type Response =\n  | SendMagicLinkResponse\n  | LoginResponse\n  | LogoutResponse\n  | SubscribeResponse\n  | UnsubscribeResponse\n  | ReducerEventResponse\n  | UpdatedValueResponse\n  | ParseErrorResponse\n  | RegisterReducerResponse\n  | ResolveDispatchResponse\n  | RuntimeDebugResponse;\n","import { useState, useEffect } from \"react\";\nimport { Request, Request_, Response, User } from \"./shared-types\";\n\n//////////////////////////////////////////\n// GLOBALS\n//////////////////////////////////////////\n\nconst COMPOSE_USER_CACHE_KEY = \"compose-cache:user\";\nconst COMPOSE_TOKEN_KEY = \"compose-token\";\n\nconst subscriptions: {\n  [key: string]: Set<(data: React.SetStateAction<unknown>) => void>;\n} = {};\n\nlet loggedInUser: User | null = null;\nif (localStorage.getItem(COMPOSE_USER_CACHE_KEY)) {\n  loggedInUser = safeParseJSON(localStorage.getItem(COMPOSE_USER_CACHE_KEY));\n}\nconst loggedInUserSubscriptions = new Set<(user: User) => void>();\n\nconst ensureSet = (name: string) =>\n  (subscriptions[name] = subscriptions[name] || new Set());\n\nconst callbacks: {\n  [key: string]: [(...args: any[]) => void, (error: string) => void];\n} = {};\n\nlet socketOpen = false;\nlet queuedMessages: Request_[] = [];\n\nconst socket = new WebSocket(\"ws://localhost:3000\"); // TODO - point this to prod on releases\n\n//////////////////////////////////////////\n// UTILS\n//////////////////////////////////////////\n\nfunction safeParseJSON(str: string | null) {\n  if (!str) {\n    return null;\n  }\n\n  try {\n    return JSON.parse(str);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction send(data: Request) {\n  const requestId = (Math.random() + 1).toString(36).substring(7);\n  return new Promise<User>((resolve, reject) => {\n    callbacks[requestId] = [resolve, reject];\n    if (socketOpen) {\n      actuallySend({ ...data, requestId });\n    } else {\n      // TODO - after a while, close and try to reconnect\n      // TODO - eventually, throw an error (promise throw)\n      //        on all the places that pushed to this queue\n      queuedMessages.push({ ...data, requestId });\n    }\n  });\n}\n\nfunction actuallySend(data: Request_) {\n  try {\n    socket.send(JSON.stringify(data));\n    queuedMessages = queuedMessages.filter((d) => d === data);\n  } catch (e) {\n    console.error(e);\n  }\n}\n\nfunction updateValue(name: string, value: unknown) {\n  ensureSet(name).forEach((callback) => callback(value));\n  // TODO - cache value in localstorage\n}\n\n// https://blog.trannhat.xyz/generate-a-hash-from-string-in-javascript/\nconst hashCode = function (s: string) {\n  return s.split(\"\").reduce(function (a, b) {\n    a = (a << 5) - a + b.charCodeAt(0);\n    return a & a;\n  }, 0);\n};\n\n//////////////////////////////////////////\n// SETUP\n//////////////////////////////////////////\n\n// On page load, check if the URL contains the `magicLinkToken` param\nconst magicLinkToken = new URLSearchParams(window.location.search).get(\n  \"composeToken\"\n);\nif (magicLinkToken) {\n  send({\n    type: \"LoginRequest\",\n    token: magicLinkToken,\n  });\n}\n\nsocket.addEventListener(\"open\", function (event) {\n  socketOpen = true;\n  queuedMessages.forEach(actuallySend);\n\n  if (localStorage.getItem(COMPOSE_TOKEN_KEY)) {\n    send({\n      type: \"LoginRequest\",\n      token: localStorage.getItem(COMPOSE_TOKEN_KEY) as string,\n    });\n  }\n});\n\nsocket.addEventListener(\"close\", function (event) {\n  socketOpen = false;\n  // TODO - reopen socket\n});\n\n//////////////////////////////////////////\n// HANDLE SERVER RESPONSES\n//////////////////////////////////////////\n\nsocket.addEventListener(\"message\", function (event) {\n  const data: Response | null = safeParseJSON(event.data);\n  if (!data) {\n    console.error(\"Invalid JSON received from server\");\n    console.error(event);\n    return;\n  }\n\n  if (\n    data.type === \"SubscribeResponse\" ||\n    data.type === \"UpdatedValueResponse\"\n  ) {\n    if (data.type === \"UpdatedValueResponse\" && data.error) {\n      callbacks[data.requestId][1](\n        `${data.name}: Cannot set this state because there is a reducer with the same name`\n      );\n    } else {\n      callbacks[data.requestId][0](data.value);\n      updateValue(data.name, data.value);\n    }\n  } else if (data.type === \"LoginResponse\") {\n    if (data.token) {\n      localStorage.setItem(COMPOSE_TOKEN_KEY, data.token);\n      localStorage.setItem(COMPOSE_USER_CACHE_KEY, JSON.stringify(data.user));\n      loggedInUser = data.user || null;\n      callbacks[data.requestId]?.[0](data.user);\n      loggedInUserSubscriptions.forEach((callback) =>\n        callback(data.user as User)\n      );\n    } else if (data.error) {\n      callbacks[data.requestId]?.[1](data.error);\n    } else {\n      // token already saved in localStorage, so just call the callback\n      loggedInUser = data.user || null;\n      callbacks[data.requestId]?.[0](data.user);\n    }\n  } else if (data.type === \"ParseErrorResponse\") {\n    console.error(\"Sent invalid JSON to server\");\n    console.error(data.cause);\n  } else if (data.type === \"ResolveDispatchResponse\") {\n    callbacks[data.requestId]?.[0](data.resolveValue);\n    updateValue(data.name, data.resolveValue);\n  } else if (data.type === \"RuntimeDebugResponse\") {\n    data.consoles.forEach((log) => console.log(`${data.name}: ${log}`));\n    if (data.error) {\n      console.error(`${data.name}\\n\\n${data.error.stack}`);\n    }\n  } else {\n    console.warn(`Unknown response type from Compose server: ${data.type}`);\n  }\n});\n\n//////////////////////////////////////////\n// Common: Cloud State & Reducer\n//////////////////////////////////////////\n\nfunction useSubscription(name: string, setState: (data: unknown) => void) {\n  useEffect(() => {\n    if (!ensureSet(name).size) {\n      send({\n        type: \"SubscribeRequest\",\n        name,\n      });\n    }\n    subscriptions[name].add(setState);\n    return () => {\n      subscriptions[name].delete(setState);\n      if (!ensureSet(name).size) {\n        socket.send(\n          JSON.stringify({\n            action: \"unsubscribe\", // TODO - fix this\n            name,\n          })\n        );\n      }\n    };\n  }, [setState]);\n}\n\n//////////////////////////////////////////\n// Cloud State\n//////////////////////////////////////////\n\nexport function setCloudState<A>(name: string, value: unknown) {\n  send({\n    type: \"StateUpdateRequest\",\n    name,\n    value,\n  });\n}\n\nexport function useCloudState(name: string, initialState: unknown) {\n  const [state, setState] = useState(initialState);\n  useSubscription(name, setState);\n  return [state, (s: unknown) => setCloudState(name, s)];\n}\n\n//////////////////////////////////////////\n// CLOUD REDUCER\n//////////////////////////////////////////\n\nexport function dispatchCloudReducerEvent<A>(name: string, event: A) {\n  send({\n    type: \"ReducerEventRequest\",\n    name,\n    value: event,\n  });\n}\n\nexport function useCloudReducer<State, Action, Response>({\n  name,\n  initialState,\n  reducer,\n}: {\n  name: string;\n  initialState: State;\n  reducer: (\n    state: State,\n    action: Action,\n    reducer: (response: Response) => void\n  ) => State;\n}) {\n  const [state, setState] = useState(initialState as unknown);\n  useSubscription(name, setState);\n\n  useEffect(() => {\n    send({\n      type: \"RegisterReducerRequest\",\n      name,\n      reducerCode: reducer.toString(),\n      initialState,\n    });\n  }, [name, reducer.toString(), JSON.stringify(initialState)]);\n\n  return [state, (s: State) => dispatchCloudReducerEvent(name, s)];\n}\n\n//////////////////////////////////////////\n// USER & AUTH\n//////////////////////////////////////////\n\nexport function magicLinkLogin({\n  email,\n  appName,\n  redirectURL,\n}: {\n  email: string;\n  appName: string;\n  redirectURL?: string;\n}): Promise<User> {\n  redirectURL = redirectURL || window.location.href;\n  return send({\n    type: \"SendMagicLinkRequest\",\n    email,\n    appName,\n    redirectURL,\n  });\n}\n\nexport function useUser() {\n  const [user, setUser] = useState<User | null>(loggedInUser);\n  useEffect(() => {\n    loggedInUserSubscriptions.add(setUser);\n    return () => {\n      loggedInUserSubscriptions.delete(setUser);\n    };\n  }, []);\n  return user;\n}\n\nexport function logout() {\n  localStorage.removeItem(COMPOSE_TOKEN_KEY);\n  localStorage.removeItem(COMPOSE_USER_CACHE_KEY);\n  socket.send(JSON.stringify({ type: \"LogoutRequest\" }));\n}\n"],"names":[],"version":3,"file":"types.d.ts.map"}